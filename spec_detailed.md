# 順番待ちシステム - 詳細仕様書

このドキュメントは、spec.mdの不明確な点を具体化した詳細仕様です。

---

## 1. 受付番号の採番ルール

### 採番方式
- **完全な連番（リセットなし）**
- 001, 002, 003... と連続して採番
- 日次や起動時のリセットは行わない

### データ保持
- **履歴は保持する**
- 過去の受付データは削除せずにデータベースに保存

---

## 2. 推定待ち時間の表示

### 表示方針
- **推定待ち時間は表示しない**
- 顧客向け画面では「あと何組待ちか」のみを表示
- 店舗設定テーブルの「1組あたりの平均案内時間」は不要

### 理由
- 推定時間の不正確さによる顧客の混乱を避けるため
- シンプルな情報提供に徹する

---

## 3. 座席タイプと呼び出し順序

### 呼び出し方式
- **完全に受付順（先着順のみ）**
- すべての受付を受付時刻順に一列で管理
- 座席タイプ（テーブル/カウンター）や禁煙/喫煙は情報として記録するのみ
- 呼び出し順序には影響しない

### データの使用目的
- 座席タイプと禁煙/喫煙の情報は、店舗側が席を案内する際の参考情報として使用
- キュー管理には使用しない

---

## 4. キャンセル・不在処理

### 処理フロー
- **保留ステータスを設ける**
- 呼び出し時に顧客が不在の場合、店舗スタッフが「保留」に変更
- 保留中の受付は後から再呼び出し可能

### ステータス遷移
- 待機中 → 呼び出し中 → 保留（不在時）
- 保留 → 呼び出し中（再呼び出し）
- 保留 → キャンセル（最終的に来なかった場合）
- 呼び出し中 → 案内完了（顧客が来た場合）

### 再呼び出し機能
- 必要
- 保留ステータスの受付を再度「呼び出し中」に変更可能

---

## 5. QRコードの有効期限とセキュリティ

### 5-1. QRコード（URL）の有効期限
- **案内完了またはキャンセル後は見られなくなる**
- ステータスが「案内完了」または「キャンセル」になったら、URLにアクセスしても無効と表示
- 待機中・呼び出し中・保留中のみアクセス可能

### 5-2. URLに含めるパラメータ
- **受付ID + ランダムトークン**
- URL形式例: `/queue/123?token=abc123def456...`
- トークンはUUID等のランダム文字列
- 受付登録時にトークンを生成してDBに保存
- URLアクセス時に受付IDとトークンの両方を検証

### 5-3. 他の顧客の待ち状況
- **全体の待ち状況（待ち組数）も表示**
- 表示内容:
  - 現在の呼び出し番号（大きく表示）
  - 自分の受付番号
  - あと何組待ちか
  - 現在の待ち組数（全体）

---

## 6. 受付時の入力項目

### 6-1. 各項目の必須/任意
- **大人人数**: 必須
- **子供人数**: 必須（0人もOK）
- **座席タイプ**: 必須（テーブル/カウンター）
- **禁煙/喫煙**: 必須（デフォルトは禁煙）

### 6-2. 人数の制限
- **合計人数の上限**: 8人まで
- 大人+子供の合計が8人を超える場合はエラー
- 最小人数: 大人1人以上（大人0人+子供のみは不可）

### 6-3. その他の定義
- **子供の定義**: 小学生まで（中学生以上は大人としてカウント）
- **初期開発の選択肢**: 座席タイプ（テーブル/カウンター）と禁煙/喫煙の2種類のみ
- 将来的な拡張は想定するが、初期バージョンではこの2つに限定

---

## 7. 受付情報の編集

### 編集可否
- **編集可能（すべての項目を変更可）**
- 受付番号以外のすべての項目を編集可能:
  - 大人人数
  - 子供人数
  - 座席タイプ
  - 禁煙/喫煙

### 編集可能なタイミング
- すべてのステータスで編集可能（待機中、呼び出し中、保留中）
- 案内完了またはキャンセル後は編集不可

### 編集時の制約
- 人数の上限（合計8人）などのバリデーションは編集時にも適用

---

## 8. 店舗側の認証システム

### 8-1. 認証方式
- **変更可能なパスワード**
- システムに1つのパスワードを設定（全スタッフが共有）
- 管理画面からパスワードを変更可能
- ユーザーID等は不要（シンプルな認証）

### 8-2. 初期設定
- **デフォルトパスワードを使用**
- 初回起動時のデフォルトパスワード: `admin` または `password`（実装時に決定）
- 初回ログイン後、パスワード変更を推奨するメッセージを表示
- パスワードは管理画面の設定ページから変更可能

### 8-3. セキュリティ
- パスワードはハッシュ化してデータベースに保存
- HTTPS必須（平文でのパスワード送信を防ぐ）

---

## 9. Web Push通知

### 9-1. 通知のタイミング
- **設定可能（店舗側が組数を設定）**
- 店舗設定で「あと何組で通知するか」を設定可能
- デフォルト値: あと3組
- 設定範囲: 1〜10組程度

### 9-2. 通知の優先度
- **オプション機能（後回しでもOK）**
- 初期リリースでは実装せず、基本機能の完成を優先
- フェーズ2以降で実装を検討

### 9-3. 実装時の仕様（将来用）
- 顧客がQRコード画面で通知を許可した場合のみ送信
- 通知内容: 「まもなくお呼びします（あと○組）」
- 通知は1回のみ（同じ受付に対して複数回送信しない）

---

## 10. リアルタイム更新の実装方法

### 10-1. 実装方式
- **WebSocket**
- 双方向通信で店舗側の操作を顧客画面に即座に反映
- 遅延を最小限に抑え、リアルタイム性を重視

### 10-2. 技術スタック
- バックエンド: FastAPIのWebSocketサポートを使用
- フロントエンド: WebSocket APIまたはSocket.IOクライアント
- 接続が切れた場合の自動再接続機能を実装

### 10-3. 更新対象
WebSocketで更新が必要な情報：
- 店舗側管理画面:
  - 待ち状況一覧の更新
  - ダッシュボードの待ち組数
  - 新規受付の追加
- 顧客側画面:
  - 現在の呼び出し番号
  - 自分の順番（あと何組待ちか）
  - 待ち組数

---

## 11. 管理画面の構成

### 画面一覧（5画面構成）

#### 1. ログイン画面
- **目的**: 店舗スタッフの認証
- **表示要素**:
  - パスワード入力フィールド
  - ログインボタン
  - 初回ログイン時：パスワード変更を推奨するメッセージ

#### 2. ダッシュボード（ホーム画面）
- **目的**: 待ち状況の全体把握とクイックアクセス
- **表示要素**:
  - 待ち状況サマリー:
    - 現在の待ち組数（大きく表示）
    - 呼び出し中の番号（大きく表示）
  - クイックアクション:
    - 「新規受付」ボタン → 新規受付画面へ遷移
    - 「待ち状況一覧」ボタン → 一覧画面へ遷移
  - 最近の受付リスト（直近5件程度）:
    - 受付番号、人数、ステータスを簡易表示
- **ナビゲーション**: 各画面へのメニュー表示

#### 3. 新規受付画面
- **目的**: 新規受付の登録とQRコード発行
- **入力フォーム**:
  - 大人人数（必須、数値入力）
  - 子供人数（必須、0可、数値入力）
  - 座席タイプ（必須、ラジオボタン: テーブル/カウンター）
  - 禁煙/喫煙（必須、ラジオボタン、デフォルト: 禁煙）
  - バリデーション: 合計人数8人まで
- **登録後の表示**:
  - 受付番号（大きく表示）
  - QRコード画像（顧客に見せる用）
  - 待ち組数
  - 「続けて受付」ボタン（連続受付モード - フォームをクリア）
  - 「ダッシュボードに戻る」ボタン

#### 4. 待ち状況一覧画面
- **目的**: すべての受付の詳細管理
- **フィルタ機能**:
  - ステータスフィルタ（待機中のみ/すべて表示）
  - ソート: 受付時刻順（昇順/降順）
- **一覧テーブル**:
  - 表示列:
    - 受付番号
    - 受付時刻
    - 人数（大人/子供）
    - 座席タイプ
    - 禁煙/喫煙
    - ステータス
    - アクション
- **各行のアクション**:
  - 「呼び出し」ボタン（待機中 → 呼び出し中）
  - 「保留」ボタン（呼び出し中 → 保留）
  - 「案内完了」ボタン（呼び出し中 → 案内完了）
  - 「キャンセル」ボタン（任意のステータス → キャンセル）
  - 「編集」ボタン → 編集モーダル表示
- **編集モーダル**:
  - 受付情報のすべての項目を編集可能
  - 保存/キャンセルボタン

#### 5. 設定画面
- **目的**: システム設定とパスワード管理
- **設定項目**:
  - パスワード変更:
    - 現在のパスワード
    - 新しいパスワード
    - パスワード確認（再入力）
    - 「パスワード変更」ボタン
  - 店舗情報（オプション）:
    - 店舗名
    - 営業開始時刻
    - 営業終了時刻
    - 「保存」ボタン

### 画面遷移フロー
```
ログイン
  ↓
ダッシュボード ←→ 新規受付画面
  ↓               ↓（QRコード表示後）
待ち状況一覧 ←→ ダッシュボード
  ↓
設定画面
```

### 共通要素
- **ヘッダー/ナビゲーション**: 全画面共通
  - ロゴまたは店舗名
  - メニュー（ダッシュボード、新規受付、一覧、設定）
  - ログアウトボタン
- **レスポンシブ対応**: タブレット/PC対応

---

## 12. 受付番号のフォーマット

### 12-1. 桁数
- **可変長**
- 初期は1桁から開始（1, 2, 3...）
- 桁数の上限なし（システムの制限まで）

### 12-2. 表示形式
- **番号のみ**
- プレフィックスなし
- 例: 1, 2, 3, ..., 99, 100, 101, ..., 999, 1000...

### 12-3. 上限を超えた場合
- **桁数を増やす**
- 自動的に桁数が増加（999 → 1000）
- システム的な上限まで対応（INT型の範囲）

### 12-4. 表示時の考慮事項
- データベースには数値として保存
- 表示時は文字列に変換
- ゼロパディングは行わない

---

## 13. ステータス変更履歴

### 実装方針
- **ステータス変更履歴テーブルは実装しない**
- queuesテーブルの各タイムスタンプで十分
  - `registered_at`: 受付日時
  - `called_at`: 呼び出し日時
  - `on_hold_at`: 保留日時
  - `completed_at`: 案内完了日時
  - `cancelled_at`: キャンセル日時

### 理由
- シンプルな実装を優先
- 基本的な運用には各タイムスタンプで十分
- 必要に応じて将来的に追加可能

---

## 14. データ保持期間

### 保持方針
- **永続保持**
- すべての受付データを削除せずに保持
- 案内完了やキャンセル後もデータベースに残す

### 理由
- 過去の利用状況の分析が可能
- トラブル発生時の確認用
- データ量は大きくならない想定（1日数十〜数百件程度）

### 将来的な拡張
- 必要に応じて、管理画面から手動削除機能を追加可能
- アーカイブ機能（古いデータを別テーブルに移動）も検討可能

---

## 15. その他のテーブル

### 15-1. WebSocket接続管理
- **テーブルは不要**
- WebSocket接続情報はメモリ上で管理
- アプリケーション層（FastAPI）で処理
- 接続/切断時にインメモリの接続リストを更新

### 15-2. セッション管理
- **テーブルは不要**
- JWTトークンベース認証を採用
- ログイン時にトークンを発行
- トークンをクライアント側（Cookie/LocalStorage）に保存
- ステートレスな認証方式

### 実装方針
- データベーステーブル数を最小限に保つ
- シンプルな構成で管理コストを削減
- スケーラビリティの向上（ステートレス）

---
